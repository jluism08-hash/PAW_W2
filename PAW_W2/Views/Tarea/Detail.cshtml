@model PAW_W2.Models.Tarea
@using PAW_W2.Models
@{ ViewBag.Title = "Detalle"; }

<div class="container mt-4">
    <div class="row justify-content-center">
        <div class="col-12 col-md-8 col-lg-6">
            <div class="card shadow-sm">
                <div class="card-body">

                    <h2 class="text-center mb-3">@Model.Titulo</h2>
                    <p class="mb-4">@Model.Descripcion</p>

                    <ul class="list-group list-group-flush mb-3">
                        <li class="list-group-item"><b>Categoría:</b> @Model.Categoria</li>
                        <li class="list-group-item"><b>Lenguajes:</b> @Model.Lenguajes</li>
                        <li class="list-group-item"><b>Repo:</b> <a href="@Model.UrlRepo" target="_blank">@Model.UrlRepo</a></li>
                        <li class="list-group-item"><b>Fecha:</b> @Model.Fecha</li>
                        <li class="list-group-item"><b>Autor:</b> @Model.AutorId</li>
                    </ul>

                    <div class="d-flex justify-content-between mb-4">
                        @if (Session["UserId"] != null && (string)Session["UserId"] == Model.AutorId)
                        {
                            @Html.ActionLink("Editar", "Edit", "Tarea", new { id = Model.Id }, new { @class = "btn btn-outline-primary" })
                            @Html.ActionLink("Eliminar", "Delete", "Tarea", new { id = Model.Id }, new { @class = "btn btn-outline-danger" })
                        }
                        @Html.ActionLink("Volver", "Index", "Tarea", null, new { @class = "btn btn-secondary ms-auto" })
                    </div>

                    <p class="mb-4"><b>Promedio:</b> @String.Format("{0:0.0}", ViewBag.Promedio) (@ViewBag.Cant)</p>

                    <form id="frmRate" class="border rounded p-3 mb-4 bg-light">
                        <div class="mb-3">
                            <label class="form-label">Puntuación</label>
                            <select name="puntuacion" class="form-select" required>
                                <option value="">--</option>
                                <option>1</option>
                                <option>2</option>
                                <option>3</option>
                                <option>4</option>
                                <option>5</option>
                            </select>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Comentario</label>
                            <input name="comentario" class="form-control" />
                        </div>
                        <button type="submit" class="btn btn-primary w-100">Enviar</button>
                    </form>

                    <div id="msgRate" class="text-success mb-4"></div>

                    <h3>Comentarios</h3>
                    <ul class="list-group mb-4">
                        @foreach (var c in (IEnumerable<Evaluacion>)ViewBag.Comentarios)
                        {
                            <li class="list-group-item">
                                <b>@c.UsuarioId</b> (@c.Puntuacion): @c.Comentario
                                <small class="text-muted">@c.Fecha</small>
                            </li>
                        }
                    </ul>

                </div>
            </div>
        </div>
    </div>
</div>


@section scripts{
    <script>
$(function(){
  $('#frmRate').on('submit', function(e){
    e.preventDefault();
    $.ajax({
        url:'@Url.Action("RateAjax","Tarea", new { id = Model.Id })',
        type:'POST',
        data: $('#frmRate').serialize() + '&tareaId=@Model.Id',

        success: x => {
            if (!x.ok) {
                $('#msgRate').text(x.msg || 'Error');
                return;
            }
            $('#msgRate').text('Calificado');
            $('#score').text('Promedio: ' + x.promedio.toFixed(1) + ' ('+x.cant+')');
            $('#frmRate')[0].reset();
        },
        error: e => {
            console.log(e);
            $('#msgRate').text('Error');
        }
    });
  });
});
    </script>
}
